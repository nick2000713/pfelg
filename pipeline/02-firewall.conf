# 02-firewall.conf
################################################################################
# Based on official pfELK v23.09 - Adapted for Docker                         #
################################################################################

filter {
  ### filterlog ###
  if [log][syslog][appname] =~ /^filterlog$/ {
    mutate {
      add_tag => "firewall"
      add_field => { "[event][dataset]" => "pfelk.firewall" }
      replace => { "[log][syslog][appname]" => "firewall" }
      copy => { "filter_message" => "pfelk_csv" }
    }
    mutate {
      strip => "pfelk_csv"
      split => { "pfelk_csv" => "," }
    }

    # Common Fields
    mutate {
      add_field => {
        "[rule][id]" =>           "%{[pfelk_csv][0]}"
        "[pf][rule][subid]" =>    "%{[pfelk_csv][1]}"
        "[pf][anchor]" =>         "%{[pfelk_csv][2]}"
        "[rule][uuid]" =>         "%{[pfelk_csv][3]}"
        "[interface][name]" =>    "%{[pfelk_csv][4]}"
        "[event][reason]" =>      "%{[pfelk_csv][5]}"
        "[event][action]" =>      "%{[pfelk_csv][6]}"
        "[network][direction]" => "%{[pfelk_csv][7]}"
        "[network][type]" =>      "%{[pfelk_csv][8]}"
      }
    }

    # IPv4
    if [network][type] == "4" {
      mutate {
        add_field => {
          "[pf][tos]" =>               "%{[pfelk_csv][9]}"
          "[pf][ecn]" =>               "%{[pfelk_csv][10]}"
          "[pf][ttl]" =>               "%{[pfelk_csv][11]}"
          "[pf][id]" =>                "%{[pfelk_csv][12]}"
          "[pf][offset]" =>            "%{[pfelk_csv][13]}"
          "[pf][flags]" =>             "%{[pfelk_csv][14]}"
          "[network][iana_number]" =>  "%{[pfelk_csv][15]}"
          "[network][transport]" =>    "%{[pfelk_csv][16]}"
          "[pf][packet][length]" =>    "%{[pfelk_csv][17]}"
          "[source][ip]" =>            "%{[pfelk_csv][18]}"
          "[destination][ip]" =>       "%{[pfelk_csv][19]}"
        }
      }
      # TCP
      if [network][transport] == "tcp" {
        mutate {
          add_field => {
            "[source][port]" =>              "%{[pfelk_csv][20]}"
            "[destination][port]" =>         "%{[pfelk_csv][21]}"
            "[pf][data_length]" =>           "%{[pfelk_csv][22]}"
            "[pf][tcp][flags]" =>            "%{[pfelk_csv][23]}"
            "[pf][tcp][sequence_number]" =>  "%{[pfelk_csv][24]}"
            "[pf][tcp][ack]" =>              "%{[pfelk_csv][25]}"
            "[pf][tcp][window]" =>           "%{[pfelk_csv][26]}"
            "[pf][tcp][urg]" =>              "%{[pfelk_csv][27]}"
            "[pf][tcp][options]" =>          "%{[pfelk_csv][28]}"
          }
        }
      }
      # UDP
      if [network][transport] == "udp" {
        mutate {
          add_field => {
            "[source][port]" =>        "%{[pfelk_csv][20]}"
            "[destination][port]" =>   "%{[pfelk_csv][21]}"
            "[pf][data_length]" =>     "%{[pfelk_csv][22]}"
          }
        }
      }
      # ICMP
      if [network][transport] == "icmp" {
        mutate {
          add_field => {
            "[pf][icmp][type]" => "%{[pfelk_csv][20]}"
          }
        }
      }
    }

    # IPv6
    if [network][type] == "6" {
      mutate {
        add_field => {
          "[pf][class]" =>             "%{[pfelk_csv][9]}"
          "[pf][flow]" =>              "%{[pfelk_csv][10]}"
          "[pf][hoplimit]" =>          "%{[pfelk_csv][11]}"
          "[network][transport]" =>    "%{[pfelk_csv][12]}"
          "[network][iana_number]" =>  "%{[pfelk_csv][13]}"
          "[pf][packet][length]" =>    "%{[pfelk_csv][14]}"
          "[source][ip]" =>            "%{[pfelk_csv][15]}"
          "[destination][ip]" =>       "%{[pfelk_csv][16]}"
        }
      }
      # TCP IPv6
      if [network][transport] == "tcp" {
        mutate {
          add_field => {
            "[source][port]" =>              "%{[pfelk_csv][17]}"
            "[destination][port]" =>         "%{[pfelk_csv][18]}"
            "[pf][data_length]" =>           "%{[pfelk_csv][19]}"
            "[pf][tcp][flags]" =>            "%{[pfelk_csv][20]}"
            "[pf][tcp][sequence_number]" =>  "%{[pfelk_csv][21]}"
            "[pf][tcp][ack]" =>              "%{[pfelk_csv][22]}"
            "[pf][tcp][window]" =>           "%{[pfelk_csv][23]}"
            "[pf][tcp][urg]" =>              "%{[pfelk_csv][24]}"
            "[pf][tcp][options]" =>          "%{[pfelk_csv][25]}"
          }
        }
      }
      # UDP IPv6
      if [network][transport] == "udp" {
        mutate {
          add_field => {
            "[source][port]" =>        "%{[pfelk_csv][17]}"
            "[destination][port]" =>   "%{[pfelk_csv][18]}"
            "[pf][data_length]" =>     "%{[pfelk_csv][19]}"
          }
        }
      }
    }

    # ECS: Rename network type/direction
    if [network][type] == "4" {
      mutate { update => { "[network][type]" => "ipv4" } }
    }
    if [network][type] == "6" {
      mutate { update => { "[network][type]" => "ipv6" } }
    }
    if [network][direction] == "in" {
      mutate { update => { "[network][direction]" => "ingress" } }
    }
    if [network][direction] == "out" {
      mutate { update => { "[network][direction]" => "egress" } }
    }

    # Convert to integer
    mutate {
      convert => {
        "[source][port]" => "integer"
        "[destination][port]" => "integer"
      }
    }
  }
}
